import csv

def leer_csv(Nombre_Archivo: str)->list:
    lista = []
    with open(Nombre_Archivo, "r", encoding="utf8") as archivo:
        lector = csv.reader(archivo)
        for linea in lector:
            lista.append(linea)
    return lista

def Pedir_Datos() -> list:
    Nombre_Producto = input("Ingrese el Nombre del Producto: ")
    Vendedor = input("Ingrese el Nombre del Vendedor: ")
    Precio = float(input("Ingrese el precio: "))
    Cantidad = float(input("Ingrese la Cantidad de Existencia: "))
    Ventas = float(input("Ventas Totales: "))
    Dia = int(input("Ingrese el día en que fue ingresado: "))
    Mes = int(input("Ingrese el Mes en que fue ingresado: "))
    Año = int(input("Ingrese el año en que fue ingresado: "))
    Fecha = f"{Dia}-{Mes}-{Año}"
    Datos = [Nombre_Producto, Vendedor, Precio, Cantidad, Ventas, Fecha]
    return Datos

def Registrar_Producto(Nombre_archivo: str, Datos: list) -> None:
    with open(Nombre_archivo, "a", newline="\n", encoding="utf8") as archivo:
        escritor = csv.writer(archivo)
        escritor.writerow(Datos)
        print("Se ha agregado correctamente")

def Consulta_Avanzada(Nombre_Archivo: str, Nombre: str) -> list:
    Resultado = []
    Busqueda = Nombre.strip().lower()

    with open(Nombre_Archivo, "r", encoding="utf8") as archivo:
        Lectura = csv.reader(archivo)
        encontrado = False

        for fila in Lectura:
            if fila:
                Nombre_en_fila = fila[0].strip().lower()
                if Nombre_en_fila == Busqueda:
                    Resultado.append(fila)
                    print(f"""
Nombre: {fila[0]}
Vendedor: {fila[1]}
Precio: {fila[2]}
Cantidad Existencia: {fila[3]}
Ventas: {fila[4]}
Llegada almacen: {fila[5]}
""")
                    encontrado = True
                    return Resultado

        if not encontrado:
            print("El producto no se encuentra en la base de datos")
            return Resultado

def Eliminar_Producto(Nombre_Archivo: str) -> None:
    Borrar = input("Ingrese el nombre del producto que desea borrar: ")
    Resultado = Consulta_Avanzada(Nombre_Archivo, Borrar)

    if not Resultado:
        return

    lista = leer_csv(Nombre_Archivo)

    opcion = input("¿Desea eliminar este producto? si/no: ").strip().lower()
    print(Resultado)
    if opcion == "si":
        for producto in Resultado:
            lista.remove(producto)
        with open(Nombre_Archivo, "w", encoding="utf8", newline="") as archivo:
            escritor = csv.writer(archivo)
            escritor.writerows(lista)
            print("Se ha eliminado tu producto :)")
    else:
        print("No se ha eliminado tu producto")

def Ordenar_Inventario(Nombre_Archivo: str) -> None:
    lista = leer_csv(Nombre_Archivo)

    opcion = input("""
                Escoja cómo quiere ordenarlo:
                   1) Alfabéticamente
                   2) Productos más Vendidos 
                   3) Productos más Caros
                   Elija el número: """)

    if opcion == "1":
        lista_filtrada = [fila for fila in lista[1:] if fila]
        lista_ordenada = sorted(lista_filtrada, key=lambda x: x[0])

        with open(Nombre_Archivo, "w", encoding="utf8", newline="") as archivo:
            escritor = csv.writer(archivo)
            escritor.writerows([lista[0]] + lista_ordenada)

    elif opcion == "2":
        lista_filtrada = [fila for fila in lista[1:] if fila]
        lista_ordenada = sorted(lista_filtrada, key=lambda x: float(x[4]), reverse=True)

        with open(Nombre_Archivo, "w", encoding="utf8", newline="") as archivo:
            escritor = csv.writer(archivo)
            escritor.writerows([lista[0]] + lista_ordenada)

    elif opcion == "3":
        lista_filtrada = [fila for fila in lista[1:] if fila]
        lista_ordenada = sorted(lista_filtrada, key=lambda x: float(x[2]), reverse=True)

        with open(Nombre_Archivo, "w", encoding="utf8", newline="") as archivo:
            escritor = csv.writer(archivo)
            escritor.writerows([lista[0]] + lista_ordenada)
    else:
        print("Opción no válida")

def Modificar_Producto(Nombre_Archivo: str, Nombre: str) -> None:
    lista = leer_csv(Nombre_Archivo)
    Consulta = Consulta_Avanzada(Nombre_Archivo, Nombre)

    if not Consulta:
        print("No se encuentra el producto a modificar")
        return

    print("Información del producto a modificar:")

    opcion = input("¿Desea modificar este producto? si/no: ").strip().lower()
    if opcion == "si":
        nuevo_nombre = input("Nuevo Nombre del Producto: ")
        nuevo_vendedor = input("Nuevo Nombre del Vendedor: ")
        nuevo_precio = float(input("Nuevo Precio: "))
        nueva_cantidad = float(input("Nueva Cantidad de Existencia: "))
        nuevas_ventas = float(input("Nuevas Ventas Totales: "))
        nuevo_dia = int(input("Nuevo Día en que fue Ingresado: "))
        nuevo_mes = int(input("Nuevo Mes en que fue Ingresado: "))
        nuevo_anio = int(input("Nuevo Año en que fue Ingresado: "))
        nueva_fecha = f"{nuevo_dia}-{nuevo_mes}-{nuevo_anio}"

        nuevo_producto = [nuevo_nombre, nuevo_vendedor, nuevo_precio, nueva_cantidad, nuevas_ventas, nueva_fecha]

        lista = [nuevo_producto if x == Consulta[0] else x for x in lista]

        with open(Nombre_Archivo, "w", encoding="utf8", newline="") as archivo:
            escritor = csv.writer(archivo)
            escritor.writerows(lista)
        print("Se ha modificado tu producto correctamente.")
    else:
        print("No se ha modificado tu producto.")

def actualizar_ventas(Nombre_Archivo: str):
    vendedor = input("Ingrese el nombre del vendedor: ")
    producto = input("Ingrese el nombre del producto: ")

    datos = leer_csv(Nombre_Archivo)
    header = datos[0]

    ventas_index = None
    precio_index = None
    cantidad_index = None
    comision_index = None

    for i, col in enumerate(header):
        if col == "Nombre del Vendedor":
            vendedor_index = i
        elif col == "Nombre del Producto":
            producto_index = i
        elif col == "Ventas":
            ventas_index = i
        elif col == "Precio":
            precio_index = i
        elif col == "Cantidad":
            cantidad_index = i
        elif col == "Comision":
            comision_index = i

    for fila in datos[1:]:
        if (fila[vendedor_index].strip().lower() == vendedor.strip().lower() and
            fila[producto_index].strip().lower() == producto.strip().lower()):
            ventas = int(fila[ventas_index]) if fila[ventas_index].strip() else 0
            precio = float(fila[precio_index])
            cantidad = int(fila[cantidad_index])
            comision = float(fila[comision_index]) if fila[comision_index].strip() else 0

            cantidad_vendida = int(input("Ingrese la cantidad vendida: "))

            if cantidad_vendida > 0 and cantidad_vendida <= cantidad:
                ventas += cantidad_vendida
                cantidad -= cantidad_vendida
                comision += cantidad_vendida * precio

                fila[ventas_index] = str(ventas)
                fila[cantidad_index] = str(cantidad)
                fila[comision_index] = str(comision)

                with open(Nombre_Archivo, "w", newline="", encoding="utf8") as archivo:
                    escritor = csv.writer(archivo)
                    escritor.writerows([header] + datos[1:])
                print("Ventas y comisión actualizadas correctamente.")
            else:
                print("La cantidad vendida no es válida o supera la cantidad disponible.")
            break
    else:
        print("No se encontró el vendedor o producto en la base de datos.")

def menu():
    while (opcion := input(""" MENU
    1. Registro Producto
    2. Consulta Avanzada
    3. Eliminar Producto
    4. Modificar Producto
    5. Ordenar Inventario
    6. Actualizar Ventas
    7. Cerrar programa

    Introduzca su opción: """)) != "7":

        if opcion == "1":
            Datos = Pedir_Datos()
            Registrar_Producto("Inventario.csv", Datos)

        elif opcion == "2":
            Nombre = input("Ingrese el nombre del producto: ")
            Consulta_Avanzada("Inventario.csv", Nombre)

        elif opcion == "3":
            Eliminar_Producto("Inventario.csv")

        elif opcion == "4":
            Nombre = input("Ingrese el nombre del producto: ")
            Modificar_Producto("Inventario.csv", Nombre)

        elif opcion == "5":
            Ordenar_Inventario("Inventario.csv")

        elif opcion == "6":
            actualizar_ventas("Inventario.csv")
        
        elif opcion == "7":
            print("Hasta pronto")

        else:
            print("Elija una de las opciones del Menu")

    print("Hasta Pronto")

if __name__ == "__main__":
    menu()
